From 07476185bf4b5002d8e30181344649035aa85c20 Mon Sep 17 00:00:00 2001
From: Robin Humble <plaguedbypenguins@gmail.com>
Date: Tue, 29 Oct 2013 18:34:22 +1100
Subject: [PATCH] fix renderscript on armv6

Change-Id: Iebd19858892ba9c9a4c735292527bdb4fc34f961

diff --git a/include/bcc/Config/Config.h b/include/bcc/Config/Config.h
index 0331ae0..230f464 100644
--- a/include/bcc/Config/Config.h
+++ b/include/bcc/Config/Config.h
@@ -56,8 +56,13 @@
   #endif
 #endif
 
-#define DEFAULT_ARM_TRIPLE_STRING      "armv7-none-linux-gnueabi"
-#define DEFAULT_THUMB_TRIPLE_STRING    "thumbv7-none-linux-gnueabi"
+#if defined(TARGET_CPU_VARIANT_ARM11)
+  #define DEFAULT_ARM_TRIPLE_STRING      "armv6-none-linux-gnueabi"
+  #define DEFAULT_THUMB_TRIPLE_STRING    "thumbv6-none-linux-gnueabi"
+#else
+  #define DEFAULT_ARM_TRIPLE_STRING      "armv7-none-linux-gnueabi"
+  #define DEFAULT_THUMB_TRIPLE_STRING    "thumbv7-none-linux-gnueabi"
+#endif
 #define DEFAULT_MIPS_TRIPLE_STRING     "mipsel-none-linux-gnueabi"
 #define DEFAULT_X86_TRIPLE_STRING      "i686-unknown-linux"
 #define DEFAULT_X86_64_TRIPLE_STRING   "x86_64-unknown-linux"
diff --git a/lib/Support/TargetCompilerConfigs.cpp b/lib/Support/TargetCompilerConfigs.cpp
index 948e836..f7bf7cc 100644
--- a/lib/Support/TargetCompilerConfigs.cpp
+++ b/lib/Support/TargetCompilerConfigs.cpp
@@ -53,9 +53,14 @@ ARMBaseCompilerConfig::GetFeatureVector(std::vector<std::string> &pAttributes,
   llvm::sys::getHostCPUFeatures(Features);
 
 #if defined(ARCH_ARM_HAVE_VFP)
+#  if defined(TARGET_CPU_VARIANT_ARM11)
+  pAttributes.push_back("+vfp2");
+  pAttributes.push_back("-d16");
+#  else
   pAttributes.push_back("+vfp3");
-#  if !defined(ARCH_ARM_HAVE_VFP_D32)
+#    if !defined(ARCH_ARM_HAVE_VFP_D32)
   pAttributes.push_back("+d16");
+#    endif
 #  endif
 #endif
 
diff --git a/libbcc-device-build.mk b/libbcc-device-build.mk
index 54340c4..8eaf7c7 100644
--- a/libbcc-device-build.mk
+++ b/libbcc-device-build.mk
@@ -42,6 +42,9 @@ ifeq ($(TARGET_ARCH),arm)
       LOCAL_CFLAGS += -DARCH_ARM_HAVE_VFP_D32
     endif
   endif
+  ifeq ($(TARGET_CPU_VARIANT),arm11)
+    LOCAL_CFLAGS += -DTARGET_CPU_VARIANT_ARM11
+  endif
   ifeq ($(ARCH_ARM_HAVE_NEON),true)
     LOCAL_CFLAGS += -DARCH_ARM_HAVE_NEON
   endif
diff --git a/tools/bcc_compat/Android.mk b/tools/bcc_compat/Android.mk
index 51ac17e..bb6ef3a 100644
--- a/tools/bcc_compat/Android.mk
+++ b/tools/bcc_compat/Android.mk
@@ -40,6 +40,10 @@ endif
 
 LOCAL_SRC_FILES := Main.cpp
 
+ifeq ($(TARGET_CPU_VARIANT),arm11)
+  LOCAL_CFLAGS += -DTARGET_CPU_VARIANT_ARM11
+endif
+
 include $(LIBBCC_HOST_BUILD_MK)
 include $(LIBBCC_GEN_CONFIG_MK)
 include $(LLVM_HOST_BUILD_MK)
diff --git a/tools/bcc_compat/Main.cpp b/tools/bcc_compat/Main.cpp
index 1391de8..0057af9 100644
--- a/tools/bcc_compat/Main.cpp
+++ b/tools/bcc_compat/Main.cpp
@@ -178,8 +178,13 @@ bool ConfigCompiler(RSCompilerDriver &pCompilerDriver) {
   // Explicitly set ARM feature vector
   if (config->getTriple().find("arm") != std::string::npos) {
     std::vector<std::string> fv;
+#if defined(TARGET_CPU_VARIANT_ARM11)
+    fv.push_back("+vfp2");
+    fv.push_back("-d16");
+#else
     fv.push_back("+vfp3");
     fv.push_back("+d16");
+#endif
     fv.push_back("-neon");
     fv.push_back("-neonfp");
     config->setFeatureString(fv);
