From d2a99579f68a9a4491e519f5e365df754eeca03c Mon Sep 17 00:00:00 2001
From: Daz Jones <yuki@thebronasium.com>
Date: Fri, 16 Aug 2013 02:00:18 +0100
Subject: [PATCH] legacy OMX: handle QCOM colorformat

Change-Id: I21f51f8ed296503ba6210e07d730ee80126dbb8c

Conflicts:
	media/libstagefright/ACodec.cpp

diff --git a/include/media/stagefright/ACodec.h b/include/media/stagefright/ACodec.h
index b29ab8b..b8c1066 100644
--- a/include/media/stagefright/ACodec.h
+++ b/include/media/stagefright/ACodec.h
@@ -218,7 +218,7 @@ private:
     status_t submitOutputMetaDataBuffer();
     void signalSubmitOutputMetaDataBufferIfEOS_workaround();
     status_t allocateOutputBuffersFromNativeWindow();
-#ifdef USE_SAMSUNG_COLORFORMAT
+#if defined(USE_SAMSUNG_COLORFORMAT) || defined(QCOM_LEGACY_OMX)
     void setNativeWindowColorFormat(OMX_COLOR_FORMATTYPE &eNativeColorFormat);
 #endif
     status_t cancelBufferToNativeWindow(BufferInfo *info);
diff --git a/media/libstagefright/ACodec.cpp b/media/libstagefright/ACodec.cpp
index 0903f68..34d7799 100755
--- a/media/libstagefright/ACodec.cpp
+++ b/media/libstagefright/ACodec.cpp
@@ -591,15 +591,15 @@ status_t ACodec::configureOutputBuffersFromNativeWindow(
         return err;
     }
 
-#ifdef USE_SAMSUNG_COLORFORMAT
+#if defined(USE_SAMSUNG_COLORFORMAT) || defined(QCOM_LEGACY_OMX)
     OMX_COLOR_FORMATTYPE eNativeColorFormat = def.format.video.eColorFormat;
     setNativeWindowColorFormat(eNativeColorFormat);
 
     err = native_window_set_buffers_geometry(
-    mNativeWindow.get(),
-    def.format.video.nFrameWidth,
-    def.format.video.nFrameHeight,
-    eNativeColorFormat);
+            mNativeWindow.get(),
+            def.format.video.nFrameWidth,
+            def.format.video.nFrameHeight,
+            eNativeColorFormat);
 #else
     err = native_window_set_buffers_geometry(
             mNativeWindow.get(),
@@ -820,7 +820,7 @@ status_t ACodec::submitOutputMetaDataBuffer() {
     return OK;
 }
 
-#ifdef USE_SAMSUNG_COLORFORMAT
+#if defined(USE_SAMSUNG_COLORFORMAT)
 void ACodec::setNativeWindowColorFormat(OMX_COLOR_FORMATTYPE &eNativeColorFormat)
 {
     // In case of Samsung decoders, we set proper native color format for the Native Window
@@ -837,6 +837,14 @@ void ACodec::setNativeWindowColorFormat(OMX_COLOR_FORMATTYPE &eNativeColorFormat
         }
     }
 }
+#elif defined(QCOM_LEGACY_OMX)
+void ACodec::setNativeWindowColorFormat(OMX_COLOR_FORMATTYPE &eNativeColorFormat)
+{
+    if (!strncmp(mComponentName.c_str(), "OMX.qcom.", 9)) {
+        if (eNativeColorFormat == OMX_QCOM_COLOR_FormatYVU420SemiPlanar)
+            eNativeColorFormat = (OMX_COLOR_FORMATTYPE)HAL_PIXEL_FORMAT_YCrCb_420_SP;
+    }
+}
 #endif
 
 status_t ACodec::cancelBufferToNativeWindow(BufferInfo *info) {
